<psm-widget title="Receiver Scanner">
  <form role="form" #form="ngForm" novalidate>
    <div class="form-group">
      <label for="model">Mode</label>
      <select class="form-control" [disabled]="disabled || worker.config_id" [(ngModel)]="values.mode" name="model">
        <option *ngFor="let mode of modes" value="{{mode.mode}}">{{mode.name}}</option>
      </select>
    </div>
    <div *ngIf="values.freqs != undefined" class="form-group">
      <label for="start">Frequency range</label>
      <input [disabled]="disabled || worker.config_id" type="checkbox" (ngModelChange)="freqsEnabled = rangeEnabled" [(ngModel)]="rangeEnabled" class="toggle" name="range">
      <div>
        <div class="psm-input-group col-lg-3">
          <input [disabled]="disabled || worker.config_id || ! rangeEnabled" type="text" required class="form-control" [(ngModel)]="values.freqs[0].range[0]" name="start" #start="ngModel">
          <div class="help">start</div>
        </div>
        <div class="psm-input-group col-lg-3">
          <input [disabled]="disabled || worker.config_id || ! rangeEnabled" type="text" required class="form-control" [(ngModel)]="values.freqs[0].range[1]" name="end" #end="ngModel">
          <div class="help">end</div>
        </div>
        <div class="psm-input-group col-lg-3">
          <input [disabled]="disabled || worker.config_id || ! rangeEnabled" type="text" required class="form-control" [(ngModel)]="values.freqs[0].range[2]" name="step" #step="ngModel">
          <div class="help">step</div>
        </div>
        <div class="psm-input-group col-lg-3">
          <select class="form-control" [disabled]="disabled || worker.config_id || ! rangeEnabled" [(ngModel)]="values.freqs[0].exp" name="units">
            <option *ngFor="let u of units" value="{{u.value}}">{{u.label}}</option>
          </select>
          <div class="help">units</div>
        </div>
      </div>
      <div [hidden]="! rangeEnabled || (validNumber(start) && validNumber(end) && validNumber(step))" class="alert alert-danger">
        Frequency range is a required parameter, and must consist of numbers
      </div>
      <div [hidden]="! rangeEnabled || ! validNumber(start) || ! validNumber(end) || ! validNumber(step) || validRange" class="alert alert-danger">
        Invalid range: end frequency must be greater than start frequency
      </div>
    </div>
    <div class="form-group freqlist">
      <label>Discrete frequencies</label>
      <input [disabled]="disabled || worker.config_id" type="checkbox" (ngModelChange)="rangeEnabled = freqsEnabled" [(ngModel)]="freqsEnabled" class="toggle" name="freqs">
      <div class="form-group" *ngFor="let freq of values.freqs; let n = index; let last = last">
        <ng-container *ngIf="freq.range == undefined">
          <div class="psm-input-group col-lg-3">
            <input [disabled]="disabled || worker.config_id || ! freqsEnabled" type="text" required class="form-control" [(ngModel)]="freq.freq" name="value_{{n}}">
            <div *ngIf="last" class="help">value</div>
          </div>
          <div class="psm-input-group col-lg-3">
            <select class="form-control" [disabled]="disabled || worker.config_id || ! freqsEnabled" [(ngModel)]="freq.exp" name="units_{{n}}">
              <option *ngFor="let u of units" value="{{u.value}}">{{u.label}}</option>
            </select>
            <div *ngIf="last" class="help">units</div>
          </div>
          <div class="psm-input-group col-lg-3">
            <button class="form-control" [disabled]="! numeric(freq.freq) || ! freqsEnabled" (click)="onInsert(n)">Insert</button>
          </div>
          <div class="psm-input-group col-lg-3">
            <button class="form-control" [disabled]="values.freqs.length <= 2 || ! freqsEnabled" (click)="onDelete(n)">Delete</button>
          </div>
        </ng-container>
      </div>
      <div [hidden]="! freqsEnabled || validFreqs" class="alert alert-danger">
        Discrete frequency values are required, and must consist of numbers
      </div>
    </div>
    <div class="form-group">
      <div class="psm-input-group col-lg-6">
        <label for="audio">Collect audio</label>
        <select [disabled]="disabled || worker.config_id" class="form-control" [(ngModel)]="values.audio.enabled" name="audio">
          <option [ngValue]="true">On</option>
          <option [ngValue]="false">Off</option>
        </select>
      </div>
      <div class="psm-input-group col-lg-6">
        <label for="duration">Sample duration (s)</label>
        <input [disabled]="disabled" type="number" pattern="[0-9]+" required class="form-control" [(ngModel)]="values.audio.duration" name="duration" #duration="ngModel">
      </div>
    </div>
    <div [hidden]="duration.valid || duration.pristine" class="alert alert-danger">
      Sample duration is a required integer parameter
    </div>
    <div class="form-group">
      <div class="psm-input-group col-lg-6">
        <label for="threshold">Level threshold (dB)</label>
        <input [disabled]="disabled" type="number" pattern="-?[0-9]+" required class="form-control" [(ngModel)]="values.audio.threshold" name="threshold" #threshold="ngModel">
      </div>
      <div class="psm-input-group col-lg-6">
        <label for="period">Sample period (s)</label>
        <input [disabled]="disabled" type="number" pattern="[0-9]+" required class="form-control" [(ngModel)]="values.audio.period" name="period" #period="ngModel">
      </div>
    </div>
    <div [hidden]="threshold.valid || threshold.pristine" class="alert alert-danger">
      Level threshold is a required integer parameter
    </div>
    <div [hidden]="period.valid || period.pristine" class="alert alert-danger">
      Sample period is a required integer parameter
    </div>
    <div class="form-group">
      <label for="description">Description</label>
      <input type="text" class="form-control" [disabled]="disabled || worker.config_id" [(ngModel)]="values.description" name="description"/>
    </div>
    <button (click)="onStart()" class="btn btn-default" [disabled]="disabled || running || ! validScan">Start</button>
    <button (click)="onStop()" class="btn btn-default" [disabled]="disabled || ! running">Stop</button>
  </form>
  <div *ngIf="worker.config_id || worker.error" [ngClass]="{ status: true, error: worker.error != undefined }">
    <h2 *ngIf="worker.timestamp">Scan status at {{worker.timestamp | date}}</h2>
    <div *ngIf="worker.sweep">
      <span>Scan started {{worker.sweep.timestamp | date}}</span>
      <span *ngFor="let peak of worker.sweep.peaks">Peak {{peak.strength}}dB at {{peak.freq_n | freq:values.scan}}</span>
      <span *ngIf="worker.sweep.previous">{{worker.sweep.previous.strength}}dB at {{worker.sweep.previous.freq_n | freq:values.scan}}</span>
      <span *ngIf="worker.sweep.current">Reading strength at {{worker.sweep.current.freq_n | freq:values.scan}}...</span>
      <span *ngIf="worker.sweep.record">Recording audio sample at {{worker.sweep.record.freq_n | freq:values.scan}}...</span>
    </div>
    <span *ngIf="worker.error">{{worker.error}}</span>
  </div>
  <div *ngIf="user.roleIn(['data']) && ! running" class="message">
    Not running
  </div>
</psm-widget>
